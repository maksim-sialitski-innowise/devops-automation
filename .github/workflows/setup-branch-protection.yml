name: Setup Branch Protection
on:
  workflow_call:
    inputs:
      branch-name:
        type: string
        default: 'main'
    outputs:
      protection-configured:
        value: ${{ jobs.setup.outputs.success }}

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      success: ${{ steps.configure-protection.outcome == 'success' }}
    
    steps:
      - name: Configure branch protection
        id: configure-protection
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api -X PUT \
            /repos/${{ github.repository }}/branches/${{ inputs.branch-name }}/protection \
            --input - << 'EOF'
          {
            "required_status_checks": {"strict": true, "contexts": []},
            "enforce_admins": false,
            "required_pull_request_reviews": {
              "required_approving_review_count": 1,
              "dismiss_stale_reviews": true
            },
            "allow_force_pushes": false,
            "allow_deletions": false,
            "required_conversation_resolution": true
          }
          EOF
      
      - name: Enforce linear history
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh api -X PATCH /repos/${{ github.repository }} \
            -f allow_rebase_merge=true \
            -f allow_merge_commit=false \
            -f allow_squash_merge=false
