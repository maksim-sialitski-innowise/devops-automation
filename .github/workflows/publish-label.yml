name: Publish Label Reusable

# Reusable workflow for creating release candidate
on:
  workflow_call:
    inputs:
      node-version:
        description: 'Node.js version to use'
        required: false
        default: '20'
    secrets:
      NPM_TOKEN:
        required: false

jobs:
  release-candidate:
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Checkout with full history for versioning
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Get full git history
      
      # Step 2: Check if version already exists on npm
      - name: Check if version already exists on npm
        env:
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          echo "Checking if current version exists on npm..."
          # Extract version from package.json
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "Current version in package.json: $CURRENT_VERSION"
          
          # Try to check if version exists (commented for safety)
          # npm view my-package@$CURRENT_VERSION version
          # if [ $? -eq 0 ]; then
          #   echo "::error::Version $CURRENT_VERSION already exists on npm"
          #   exit 1
          # fi
          
          echo "Version check passed (stub implementation)"
      
      # Step 3: Create development version with suffix
      - name: Create dev version with suffix
        id: dev-version
        run: |
          # Get current version from package.json
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          # Create short SHA for unique identifier
          SHORT_SHA=${GITHUB_SHA::7}
          # Combine version with suffix (e.g., 1.0.0-dev-abc1234)
          DEV_VERSION="${CURRENT_VERSION}-dev-${SHORT_SHA}"
          
          # Update package.json with new version (no git tag)
          npm version $DEV_VERSION --no-git-tag-version --allow-same-version
          
          # Output the new version for use in later steps
          echo "dev_version=$DEV_VERSION" >> $GITHUB_OUTPUT
          echo "Created dev version: $DEV_VERSION"
      
      # Step 4: Setup Node.js with npm registry
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          registry-url: 'https://registry.npmjs.org/'
      
      # Step 5: Install dependencies
      - name: Install dependencies
        run: npm ci
      
      # Step 6: Build with development version
      - name: Build with dev version
        run: npm run build
      
      # Step 7: Upload release candidate artifacts
      - name: Upload release candidate artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-candidate-${{ steps.dev-version.outputs.dev_version }}
          path: |
            dist/
            package.json
      
      # Step 8: Display release information
      - name: Display release info
        run: |
          echo "## Release Candidate Ready"
          echo ""
          echo "**Version:** ${{ steps.dev-version.outputs.dev_version }}"
          echo "**Commit:** ${{ github.sha }}"
          echo "**Artifact:** release-candidate-${{ steps.dev-version.outputs.dev_version }}"