name: PR Verification Reusable

# This is a reusable workflow - can be called from other repos
on:
  workflow_call:
    inputs:
      node-version:
        description: 'Node.js version to use'
        required: false
        default: '20'

jobs:
  pr-verification:
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Checkout code from the calling repository
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Step 2: Verify locked dependencies exist
      - name: Check for package-lock.json
        run: |
          if [ ! -f "package-lock.json" ]; then
            echo "::error::Package-lock.json missing - dependencies must be locked"
            exit 1
          fi
          echo " package-lock.json found"
      
      # Step 3: Check if PR branch is up to date with main
      - name: Check if branch is up to date with main
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            if (pr.mergeable_state === 'behind') {
              core.setFailed('Branch is not up to date with main. Please rebase.');
            }
      
      # Step 4: Setup Node.js with caching for faster builds
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'
      
      # Step 5: Install dependencies using package-lock.json
      - name: Install dependencies
        run: npm ci
      
      # Step 6: Run linting (skip if no lint script exists)
      - name: Run linting
        run: npm run lint || echo "⚠️ No lint script found, skipping"
      
      # Step 7: Build the project
      - name: Build project
        run: npm run build
      
      # Step 8: Run unit tests (skip if no test script exists)
      - name: Run unit tests
        run: npm test || echo "⚠️ No test script found, skipping"