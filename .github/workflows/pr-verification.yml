name: PR Verification

on:
  workflow_call:
    inputs:
      node-version:
        type: string
        default: '20'
    outputs:
      verification-passed:
        value: ${{ jobs.verification.outputs.success }}

jobs:
  verification:
    runs-on: ubuntu-latest
    outputs:
      success: ${{ steps.final-check.outcome == 'success' }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Check locked dependencies
        run: test -f package-lock.json || (echo "Missing package-lock.json" && exit 1)
      
      - name: Check branch status
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            if (pr.mergeable_state === 'behind' || pr.mergeable_state === 'dirty') {
              core.setFailed(`Branch not ready. State: ${pr.mergeable_state}`);
            }
      
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ inputs.node-version }}
          cache: 'npm'
      
      - run: npm ci
      - run: npm run lint 2>/dev/null || echo "No lint script"
      - run: npm run build
      - run: npm test
      
      - name: Final check
        id: final-check
        run: echo "PR verification passed"
